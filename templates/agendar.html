{% extends 'painel_paciente.html' %}
{% block title %}Agendar | Paciente{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto mt-10 bg-white shadow-lg rounded-2xl p-8">
  <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">üìÖ Agendar Consulta</h1>

  <form method="POST" action="{{ url_for('agendar') }}" class="space-y-6">
    <!-- FISIOTERAPEUTA -->
    <div>
      <label for="fisioterapeuta" class="block text-gray-700 font-semibold mb-1">Selecione um fisioterapeuta:</label>

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      {% for category, message in messages %}
      <div class="mb-4 p-4 rounded-lg 
                        {% if category == 'erro' %}
                          bg-red-100 text-red-800 border border-red-300
                        {% else %}
                          bg-blue-100 text-blue-800 border border-blue-300
                        {% endif %}">
        {{ message }}
      </div>
      {% endfor %}
      {% endif %}
      {% endwith %}

      <select id="fisioterapeuta" name="fisioterapeuta" required
        class="w-full rounded-lg border border-gray-300 p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="" disabled selected>-- Escolha um profissional --</option>
        {% for fisioterapeuta in fisioterapeutas %}
        <option value="{{ fisioterapeuta.id }}">{{ fisioterapeuta.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- DATA -->
    <div>
      <label for="data-agendamento" class="block text-gray-700 font-semibold mb-1">Selecione a data:</label>
      <input type="date" id="data-agendamento" name="data-agendamento" min="{{ current_date }}" required
        onkeydown="return false"
        class="w-full rounded-lg border border-gray-300 p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-400"
        oninput="validarData(this)">
    </div>

    <!-- HOR√ÅRIO -->
    <div>
      <label for="horario" class="block text-gray-700 font-semibold mb-1">Selecione o hor√°rio:</label>
      <select id="horario" name="horario" required
        class="w-full rounded-lg border border-gray-300 p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="" disabled selected>-- Escolha um hor√°rio --</option>
      </select>
    </div>

    <!-- BOT√ÉO -->
    <button type="submit"
      class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-lg transition-all duration-300">
      Agendar
    </button>

    <p class="text-center text-sm text-gray-600">
      J√° tem um agendamento?
      <a href="{{ url_for('meus_agendamentos_paciente') }}" class="text-blue-500 hover:underline font-medium">
        Ver meus agendamentos
      </a>
    </p>
  </form>
</div>

<!-- SCRIPT DIN√ÇMICO -->
<script>
  document.getElementById('data-agendamento').addEventListener('change', carregarHorarios);
  document.getElementById('fisioterapeuta').addEventListener('change', carregarHorarios);

  function carregarHorarios() {
    const data = document.getElementById('data-agendamento').value;
    const fisioId = document.getElementById('fisioterapeuta').value;
    const select = document.getElementById('horario');

    if (!data || !fisioId) {
      select.innerHTML = '<option value="" disabled selected>-- Escolha um hor√°rio --</option>';
      return;
    }

    fetch(`/horarios_disponiveis?data=${data}&fisioterapeuta_id=${fisioId}`)
      .then(res => res.json())
      .then(horarios => {
        select.innerHTML = '<option value="" disabled selected>-- Escolha um hor√°rio --</option>';
        if (horarios.length === 0) {
          select.innerHTML += '<option disabled>‚ö†Ô∏è Nenhum hor√°rio dispon√≠vel</option>';
          return;
        }
        horarios.forEach(h => {
          select.innerHTML += `<option value="${h.valor}">${h.label}</option>`;
        });
      })
      .catch(err => {
        console.error('Erro ao carregar hor√°rios:', err);
        select.innerHTML = '<option disabled>‚ö†Ô∏è Erro ao carregar hor√°rios</option>';
      });
  }

  function validarData(input) {
    const data = new Date(input.value);
    const dia = data.getDay(); // 0=Domingo, 6=S√°bado
    if (dia === 0 || dia === 6) {
      alert('‚õî Apenas dias √∫teis (segunda a sexta) s√£o permitidos.');
      input.value = '';
    }
  }
</script>

{% endblock %}